define(["jquery"],function(d){function k(o){o.touches||(o.touches=o.originalEvent.touches)}function l(o,p){p._startY=o.touches[0].pageY,p.touchScrollTop=p.$scrollArea.scrollTop()}function m(o,p){p._curY=o.touches[0].pageY,p._moveY=p._curY-p._startY,p._moveY>0?p.direction="down":p._moveY<0&&(p.direction="up");var q=Math.abs(p._moveY);""!=p.opts.loadUpFn&&p.touchScrollTop<=0&&"down"==p.direction&&!p.isLockUp&&(o.preventDefault(),p.$domUp=d("."+p.opts.domUp.domClass),p.upInsertDOM||(p.$element.prepend('<div class="'+p.opts.domUp.domClass+'"></div>'),p.upInsertDOM=!0),f(p.$domUp,0),q<=p.opts.distance?(p._offsetY=q,p.$domUp.html(p.opts.domUp.domRefresh)):q>p.opts.distance&&q<=2*p.opts.distance?(p._offsetY=p.opts.distance+0.5*(q-p.opts.distance),p.$domUp.html(p.opts.domUp.domUpdate)):p._offsetY=p.opts.distance+0.5*p.opts.distance+0.2*(q-2*p.opts.distance),p.$domUp.css({height:p._offsetY}))}function n(o){var p=Math.abs(o._moveY);""!=o.opts.loadUpFn&&o.touchScrollTop<=0&&"down"==o.direction&&!o.isLockUp&&(f(o.$domUp,300),p>o.opts.distance?(o.$domUp.css({height:o.$domUp.children().height()}),o.$domUp.html(o.opts.domUp.domLoad),o.loading=!0,o.opts.loadUpFn(o)):o.$domUp.css({height:"0"}).on("webkitTransitionEnd mozTransitionEnd transitionend",function(){o.upInsertDOM=!1,d(this).remove()}),o._moveY=0)}function a(o){o.opts.autoLoad&&o._scrollContentHeight-o._threshold<=o._scrollWindowHeight&&c(o)}function b(o){o._scrollContentHeight=o.opts.scrollArea==e?i.height():o.$element[0].scrollHeight}function c(o){o.direction="up",o.$domDown.html(o.opts.domDown.domLoad),o.loading=!0,o.opts.loadDownFn(o)}function f(o,p){o.css({"-webkit-transition":"all "+p+"ms",transition:"all "+p+"ms"})}var j,e=window,g=document,h=d(e),i=d(g);d.fn.dropload=function(o){return new j(this,o)},j=function(p,q){var o=this;o.$element=p,o.upInsertDOM=!1,o.loading=!1,o.isLockUp=!1,o.isLockDown=!1,o.isData=!0,o._scrollTop=0,o._threshold=0,o.init(q)},j.prototype.init=function(o){var p=this;p.opts=d.extend(!0,{},{scrollArea:p.$element,domUp:{domClass:"dropload-up",domRefresh:'<div class="dropload-refresh">↓下拉刷新</div>',domUpdate:'<div class="dropload-update">↑释放更新</div>',domLoad:'<div class="dropload-load"><span class="loading"></span>加载中...</div>'},domDown:{domClass:"dropload-down",domRefresh:'<div class="dropload-refresh">↑上拉加载更多</div>',domLoad:'<div class="dropload-load"><span class="loading"></span>加载中...</div>',domNoData:'<div class="dropload-noData">暂无数据</div>'},autoLoad:!0,distance:50,threshold:"",loadUpFn:"",loadDownFn:""},o),""!=p.opts.loadDownFn&&(p.$element.append('<div class="'+p.opts.domDown.domClass+'">'+p.opts.domDown.domRefresh+"</div>"),p.$domDown=d("."+p.opts.domDown.domClass)),p._threshold=p.$domDown&&""===p.opts.threshold?Math.floor(1*p.$domDown.height()/3):p.opts.threshold,p.opts.scrollArea==e?(p.$scrollArea=h,p._scrollContentHeight=i.height(),p._scrollWindowHeight=g.documentElement.clientHeight):(p.$scrollArea=p.opts.scrollArea,p._scrollContentHeight=p.$element[0].scrollHeight,p._scrollWindowHeight=p.$element.height()),a(p),h.on("resize",function(){p._scrollWindowHeight=p.opts.scrollArea==e?e.innerHeight:p.$element.height()}),p.$element.off().on("touchstart",function(q){p.loading||(k(q),l(q,p))}),p.$element.off().on("touchmove",function(q){p.loading||(k(q,p),m(q,p))}),p.$element.off().on("touchend",function(){p.loading||n(p)}),p.$scrollArea.off().on("scroll",function(){p._scrollTop=p.$scrollArea.scrollTop(),""!=p.opts.loadDownFn&&!p.loading&&!p.isLockDown&&p._scrollContentHeight-p._threshold<=p._scrollWindowHeight+p._scrollTop&&c(p)})},j.prototype.lock=function(o){var p=this;void 0===o?"up"==p.direction?p.isLockDown=!0:"down"==p.direction?p.isLockUp=!0:(p.isLockUp=!0,p.isLockDown=!0):"up"==o?p.isLockUp=!0:"down"==o&&(p.isLockDown=!0,p.direction="up")},j.prototype.unlock=function(){var o=this;o.isLockUp=!1,o.isLockDown=!1,o.direction="up"},j.prototype.noData=function(o){var p=this;void 0===o||1==o?p.isData=!1:0==o&&(p.isData=!0)},j.prototype.resetload=function(){var o=this;"down"==o.direction&&o.upInsertDOM?o.$domUp.css({height:"0"}).on("webkitTransitionEnd mozTransitionEnd transitionend",function(){o.loading=!1,o.upInsertDOM=!1,d(this).remove(),b(o)}):"up"==o.direction&&(o.loading=!1,o.isData?(o.$domDown.html(o.opts.domDown.domRefresh),b(o),a(o)):o.$domDown.html(o.opts.domDown.domNoData))}});